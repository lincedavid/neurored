<?php

function dameBool($anterior, $actual)
{
  if($actual > $anterior) return 1;
  else return -1;
}

function createFile($data, $file)
{
  $file = substr($file, 0, -4); //Al archivo le eliminamos el .csv para quee quede con .txt 
  $data = implode(',', $data); //Hacemos esto ya que recivimos un array
  $fileName = "files/txt/$file.txt";
  $fp = fopen($fileName, 'w');
  fwrite($fp, $data);
  fclose($fp);
  return $fileName;
}

function readCSV($archivoDestino)
{
  $file = "files/csv/".$archivoDestino;
  if (($gestor = fopen($file, "r")) !== FALSE) 
    {
      $listaValores = array();
      $listaFechas = array();
      while (($datos = fgetcsv($gestor, 1000, ",")) !== FALSE) 
	{
	  $numero = count($datos);
	  for ($c = 1; $c < $numero; $c++)  //Cambiamos c = 0, para que cargue tmb las fechas
	    {
	      if(is_numeric($datos[$c]))//Comprobamos que sea numerico
		{
		  $listaValores[] = $datos[$c]; //Guardamos las fechas en un arreglo
		  $listaFechas[] = $datos[$c-1];
		}
	    }	
	}
      $fileName = createFile($listaValores, $archivoDestino); //Creamos el archivo.dat o .txt que leera el python
      fclose($gestor);
      //return $fileName;
      return array($fileName, $listaValores, $listaFechas);
    }
}

function callPython($fileName)
{
  //return (exec("python a.py $fileName"))? "Se pudo" : "No se pudo"; //Valor ternario
  print "<br/>salida python: <br/><b>".exec("python a.py $fileName")."</b><br/><br/>";
}

function uploadFile()
{
  $bStatus = False;
  $status = "";
  if ($_POST["action"] == "upload") {
    $tamano = $_FILES["archivo"]['size'];
    $tipo = $_FILES["archivo"]['type'];
	$archivo = $_FILES["archivo"]['name'];
	$prefijo = substr(md5(uniqid(rand())),0,6);
	
	if ($archivo != "") {
	    //$destino =  "files/".$prefijo."_".$archivo;
	    $destino =  $prefijo."_".$archivo;
	  if (copy($_FILES['archivo']['tmp_name'],"files/csv/".$destino)){
	    $status = "Archivo subido: <b>".$archivo."</b>";
	    $bStatus = True;
	  } else {
	    $status = "Error al subir el archivo";
	  }
	} else {
	  $status = "Error al subir archivo";
	}
  } 
  
  if($bStatus) return array($destino, $status); //Si el archivo se cumplio regresamos la ruta del destino
  else return array($bStatus, $status); // De lo contrario un false
}

//function main()
//{
  $archivoDestino =  uploadFile(); //Subimos el archivo CVS
  if(!$archivoDestino[0])
    {
      echo "Estatus: ".$archivoDestino[1]."<br/>";
      die();
    }
  else echo "Estatus: ".$archivoDestino[1]."<br/>";

  $archivoLimpio = readCSV($archivoDestino[0]); //Pasamos el archivo CSV a un .txt que es una simple lista //Regresa un array de dos elementos, destino y la lista de los elementos
  $valoresY = implode(",",$archivoLimpio[1]);
$valoresX = implode(",",$archivoLimpio[2]); //El de las fechas
$totalE = count($archivoLimpio[1]);

//echo $valoresY."<br/>";
//echo $valoresX."<br/>";
  $run = callPython($archivoLimpio[0]); //corremos el archivo de python 
//}

//main()

?>

<html>

<head>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

  <script type="text/javascript" src="http://softm.com.mx/CMM/JS/Highcharts-2.2.5/js/highcharts.js"></script>
  <script type="text/javascript" src="http://softm.com.mx/CMM/JS/Highcharts-2.2.5/js/themes/grid.js"></script>
  <script type="text/javascript" src="http://softm.com.mx/CMM/JS/Highcharts-2.2.5/js/modules/exporting.js"></script>

<script type="text/javascript">

  var chart;
$(document).ready(function() {
    chart = new Highcharts.Chart({
      chart: {
	renderTo: 'graficaDescarga',
	    type: 'column',
	    margin: [ 50, 50, 100, 80]
	    },
	  title: {
	text: 'Indice de Criminalidad'//Aqui va el titulo 
	    },
	  xAxis: {
	  //categories: [ 'Rollo Durazno','Pay de Queso','Ensueño Mango Mango','Rollo de Mango Jr.','Pastel Mechudo','Rollo Durazno Jr.','Rollo de Piña Jr.','Rollo de Fresa','Rollo de Cajeta','Rollo de Mango' ],
	categories: [ <?php echo $valoresX; ?>],
	    labels: {
	  rotation: -45,
	      align: 'right',
	      style: {
	    font: 'normal 10px Verdana, sans-serif'
		}
	  }
	},
	  credits: {
	enabled: false
	    },
	  yAxis: {
	min: 0,
	    title: {
	  text: 'Criminalidad' //Va lo de crimen //'Cantidad de Votos'
	      }
	},
	  legend: {
	enabled: false
	    },
	  tooltip: {
	formatter: function() {
	    return '<b>'+ this.x +'</b><br/>'+'Votos:'+ this.y+ '';
	  }
	},
	  series: [{
	  name: 'Votos',
	      //data: [50,34,32,23,23,22,20,19,18,10],
	      data: [<?php echo $valoresY; ?>], //imprimimos la cantidad de criminalidad actual
	      dataLabels: {
	    enabled: true,
		rotation: -90,
		color: '#FFFFFF',
		align: 'right',
		x: -3,
		//y: 17,
		y: <?php echo $totalE; ?>,
		formatter: function() {
		return this.y;
	      },
		style: {
	      font: 'normal 13px Verdana, sans-serif'
		  }
	    }
	  }]
	  });
  });

</script> 


</head>

<body>

<table>
<tr>
<td width="70%">
  <div id="graficaDescarga" style="height: 100%; width:100%; margin: 0 auto"></div>
  </td>
  <td width="30%">
  <div id="graficaEspacio" style="height: 80%; width:100%; margin: 0 auto"></div>
  </td>
  </tr>
  <tr>
  <td colspan="2">
  <div id="graficaPie" style="min-width: 400px; height: 400px; margin: 0 auto"></div>
  </td>
  </tr>
  </table>

<!--<div id="graficaDescarga" style="height: 100%; width:100%; margin: 0 auto"></div>-->

<form action="readCSV2.php" method="post" enctype="multipart/form-data">
  <input name="archivo" type="file" size="35" />
  <input name="enviar" type="submit" value="Upload File" />
  <input name="action" type="hidden" value="upload" />     
</form>

</body>
</html>
